pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO = 'demishuaccha'
        DOCKER_CREDENTIAL_ID = 'dockerhub-creds'
        BASE_DIR = 'tingesoMS_backend'
    }

    stages {
        stage('Login to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: env.DOCKER_CREDENTIAL_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        if (isUnix()) {
                            sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                        } else {
                            bat 'echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin'
                        }
                    }
                }
            }
        }

        stage('Build and Push Microservices') {
            parallel {
                stage('Config Service') { steps { buildAndPush('config-service', 'config-service') } }
                stage('Eureka Service') { steps { buildAndPush('eureka-service', 'eureka-service') } }
                stage('Gateway Service') { steps { buildAndPush('gateway-service', 'gateway-service') } }
                stage('Auth Service') { steps { buildAndPush('tingesoMS_auth', 'tingeso-auth-service') } }
                stage('Client Service') { steps { buildAndPush('tingesoMS_client', 'tingeso-client-service') } }
                stage('Fee Service') { steps { buildAndPush('tingesoMS_fee', 'tingeso-fee-service') } }
                stage('Inventory Service') { steps { buildAndPush('tingesoMS_inventory', 'tingeso-inventory-service') } }
                stage('Kardex Service') { steps { buildAndPush('tingesoMS_kardex', 'tingeso-kardex-service') } }
                stage('Loan Service') { steps { buildAndPush('tingesoMS_loan', 'tingeso-loan-service') } }
                stage('Report Service') { steps { buildAndPush('tingesoMS_report', 'tingeso-report-service') } }
            }
        }

        stage('Deploy to K8s') {
            steps {
                script {
                    def k8sDir = "${env.BASE_DIR}/k8s" 
                    
                    // --- AJUSTE PARA LIMPIAR DESORDEN ---
                    echo "Limpiando pods duplicados o trabados antes de aplicar cambios..."
                    if (isUnix()) {
                        sh "kubectl delete pods --field-selector=status.phase=Pending"
                        sh "kubectl apply -f ${k8sDir}/ --validate=false"
                    } else {
                        bat "kubectl delete pods --field-selector=status.phase=Pending"
                        bat "kubectl apply -f ${k8sDir}/ --validate=false"
                    }
                    
                    // Reinicia los deployments para que tomen la nueva imagen
                    def deployments = "config-service eureka-service gateway-service tingeso-auth tingeso-client tingeso-fee tingeso-inventory tingeso-kardex tingeso-loan tingeso-report"
                    
                    if (isUnix()) {
                        sh "kubectl rollout restart deployment ${deployments}"
                    } else {
                        bat "kubectl rollout restart deployment ${deployments}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    if (isUnix()) { sh 'docker logout' } else { bat 'docker logout' }
                } catch (Exception e) {
                    echo "Logout failed or already logged out"
                }
            }
        }
    }
}

def buildAndPush(folderName, imageName) {
    script {
        def fullName = "${env.DOCKER_HUB_REPO}/${imageName}:latest"
        def fullPath = "${env.BASE_DIR}/${folderName}"
        
        dir(fullPath) {
            echo "Construyendo JAR para ${imageName}..."
            bat "mvn clean package -DskipTests" 
            echo "Empaquetando imagen Docker..."
            bat "docker build -t ${fullName} ."
            bat "docker push ${fullName}"
        }
    }
}