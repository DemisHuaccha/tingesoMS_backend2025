pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO = 'demishuaccha'
        DOCKER_CREDENTIAL_ID = 'dockerhub-creds'
        BASE_DIR = 'tingesoMS_backend'
        KUBECONFIG = 'C:/Users/demis/.kube/config' 
    }

    stages {
        stage('Login to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: env.DOCKER_CREDENTIAL_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        bat "docker login -u %USER% -p %PASS%"
                    }
                }
            }
        }

        stage('Build and Push Microservices') {
            parallel {
                stage('Config Service') { steps { buildAndPush('config-service', 'config-service') } }
                stage('Eureka Service') { steps { buildAndPush('eureka-service', 'eureka-service') } }
                stage('Gateway Service') { steps { buildAndPush('gateway-service', 'gateway-service') } }
                stage('Auth Service') { steps { buildAndPush('tingesoMS_auth', 'tingeso-auth-service') } }
                stage('Client Service') { steps { buildAndPush('tingesoMS_client', 'tingeso-client-service') } }
                stage('Fee Service') { steps { buildAndPush('tingesoMS_fee', 'tingeso-fee-service') } }
                stage('Inventory Service') { steps { buildAndPush('tingesoMS_inventory', 'tingeso-inventory-service') } }
                stage('Kardex Service') { steps { buildAndPush('tingesoMS_kardex', 'tingeso-kardex-service') } }
                stage('Loan Service') { steps { buildAndPush('tingesoMS_loan', 'tingeso-loan-service') } }
                stage('Report Service') { steps { buildAndPush('tingesoMS_report', 'tingeso-report-service') } }
            }
        }

        stage('Cleanup Old Apps') {
            steps {
                script {
                    echo "--- Eliminando aplicaciones antiguas (PROTEGIENDO KEYCLOAK Y DBS) ---"
                    // Estos nombres coinciden EXACTAMENTE con tu 'kubectl get deployment'
                    def appsToClean = [
                        'config-service', 'eureka-service', 'gateway-service',
                        'tingeso-auth', 'tingeso-client', 'tingeso-fee',
                        'tingeso-inventory', 'tingeso-kardex', 'tingeso-loan', 'tingeso-report'
                    ]
                    
                    appsToClean.each { name ->
                        echo "Bajando despliegue y servicio: ${name}"
                        bat "kubectl delete deployment ${name} --ignore-not-found=true"
                        bat "kubectl delete service ${name} --ignore-not-found=true"
                    }
                }
            }
        }

        stage('Deploy Infrastructure') {
            steps {
                script {
                    echo "--- Actualizando ConfigMap de Propiedades ---"
                    // El ConfigMap se refresca pero no afecta a los pods de las DBs directamente
                    bat "kubectl delete configmap config-repo --ignore-not-found"
                    bat "kubectl create configmap config-repo --from-file=${env.BASE_DIR}/config-data"

                    echo "--- Sincronizando MySQL (Sin borrar recursos existentes) ---"
                    // Solo apply: si no hay cambios en los yml, Kubernetes no hace nada
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/mysql-pv.yml"
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/mysql-secrets.yml"
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/mysql-config.yml"
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/mysql-deployment.yml"
                }
            }
        }

        stage('Deploy Core Services') {
            steps {
                script {
                    echo "--- Levantando Config Server y Eureka ---"
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/config-deployment.yml"
                    bat "kubectl wait --for=condition=ready pod -l app=config-service --timeout=120s"
                    
                    bat "kubectl apply -f ${env.BASE_DIR}/k8s/eureka-deployment.yml"
                    bat "kubectl wait --for=condition=ready pod -l app=eureka-service --timeout=120s"
                }
            }
        }

        stage('Deploy Business Services') {
            steps {
                script {
                    echo "--- Desplegando Microservicios de Negocio ---"
                    // Estos nombres de archivo corresponden a los de tu imagen (auth-deployment.yml, etc.)
                    def serviceFiles = ['gateway', 'auth', 'client', 'fee', 'inventory', 'kardex', 'loan', 'report']
                    serviceFiles.each { file ->
                        bat "kubectl apply -f ${env.BASE_DIR}/k8s/${file}-deployment.yml"
                    }
                }
            }
        }
    }

    post {
        always {
            script { bat 'docker logout' }
        }
        success {
            echo "¡Actualización completada! Keycloak y Bases de Datos permanecieron intactos."
        }
    }
}

def buildAndPush(folderName, imageName) {
    script {
        def fullName = "${env.DOCKER_HUB_REPO}/${imageName}:latest"
        def fullPath = "${env.BASE_DIR}/${folderName}"
        dir(fullPath) {
            bat "mvn clean package -DskipTests" 
            bat "docker build -t ${fullName} ."
            bat "docker push ${fullName}"
        }
    }
}